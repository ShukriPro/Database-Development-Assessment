--NOTE MAKE SURE TO REPLACE IT WITH YOUR OWN DATABASE E.g use[myDATABASE]
use[MASTER]
go

IF EXISTS (SELECT * FROM sys.triggers WHERE name = 'TRG_PREVENT_VIEW_DROP')
BEGIN
    DISABLE TRIGGER TRG_PREVENT_VIEW_DROP ON DATABASE;
END;
GO

--Task 01.
DROP PROCEDURE IF EXISTS UDP_CREATE_TABLES;
GO

CREATE PROCEDURE UDP_CREATE_TABLES
AS
BEGIN
	-- Drop the tables if they already exist
	DROP TABLE IF EXISTS points;
	DROP TABLE IF EXISTS polygons;
	DROP TABLE IF EXISTS linestrings;

	-- Create points table
	CREATE TABLE points
	(
		id INT IDENTITY PRIMARY KEY,
		point geography,
		label varchar(max)
	);

	-- Create polygons table
    CREATE TABLE polygons
    (
        id INT IDENTITY PRIMARY KEY,
		polygon geography,
		label varchar(max)
    );

    -- Create linestrings table
    CREATE TABLE linestrings
    (
        id INT IDENTITY PRIMARY KEY,
		linestring geography,
		label varchar(max)
    );

END;
GO

EXEC UDP_CREATE_TABLES


--Task 02. 
DROP PROCEDURE IF EXISTS UDP_INSERT_WKT;
GO

CREATE PROCEDURE UDP_INSERT_WKT
    @shapeType NVARCHAR(50),
    @wktString NVARCHAR(MAX),
    @description NVARCHAR(100)
AS
BEGIN
    IF @shapeType = 'POINT'
    BEGIN
        DECLARE @point NVARCHAR(MAX);
        SET @point = 'POINT';
        INSERT INTO points (point, label)
        VALUES (Geography::STPointFromText(@point + ' ' + @wktString, 4326), @description);
    END
    ELSE IF @shapeType = 'POLYGON'
    BEGIN
        DECLARE @polygon NVARCHAR(MAX);
        SET @polygon = 'POLYGON';
        INSERT INTO polygons (polygon, label)
        VALUES (Geography::STGeomFromText(@polygon + ' ' + @wktString, 4326), @description);
    END
    ELSE IF @shapeType = 'LINESTRING'
    BEGIN
        DECLARE @linestring NVARCHAR(MAX);
        SET @linestring = 'LINESTRING';
        INSERT INTO linestrings (linestring, label)
        VALUES (Geography::STGeomFromText(@linestring + ' ' + @wktString, 4326), @description);
    END
END;
GO

--Insert
--EXEC UDP_INSERT_WKT 'POINT', '(175.61798899999997 -40.340238899999996)', 'Point 1';
--EXEC UDP_INSERT_WKT 'POINT', '(175.62150809999997 -40.335364799999994)', 'Point 2';
--EXEC UDP_INSERT_WKT 'POINT', '(175.6246409 -40.3386361)', 'Point 3';
--EXEC UDP_INSERT_WKT 'POINT', '(175.608436 -40.3571431)', 'Point 4';
--EXEC UDP_INSERT_WKT 'POINT', '(175.5944019 -40.3634922)', 'Point 5';
--EXEC UDP_INSERT_WKT 'POINT', '(175.5752195 -40.3660887)', 'Point 6';

--EXEC UDP_INSERT_WKT 'LINESTRING','(175.62074699999997 -40.3380827,175.6188587 -40.33556389999999,175.57156099999997 -40.35680430000001,175.57258019999998 -40.3580715,175.5729986 -40.360082699999985,175.57486169999999 -40.36267250000001,175.5741479 -40.3638984,175.57379380000003 -40.364405299999994,175.5759181 -40.3672255)','Route 1';
--EXEC UDP_INSERT_WKT 'LINESTRING','(175.62074699999997 -40.3380827,175.62392999999997 -40.3420535,175.6288356 -40.3485573,175.58008379999998 -40.370270999999995,175.57967539999999 -40.3694905,175.5763024 -40.3675167,175.5759181 -40.3672255)','Route 2';

--EXEC UDP_INSERT_WKT 'POLYGON', '((175.6199516 -40.33832420000001,175.6197962 -40.33832309999999,175.6197949 -40.338338500000006,175.6196943 -40.3383374,175.6196903 -40.3383078,175.6195736 -40.3383109,175.6195736 -40.3383006,175.6194355 -40.33830170000001,175.6193697 -40.3382413,175.6192759 -40.3382373,175.61923969999998 -40.3383037,175.6192799 -40.33834149999999,175.61931480000004 -40.33834250000001,175.6193134 -40.338409,175.6193443 -40.33843250000001,175.6193081 -40.3384478,175.6193011 -40.33850499999999,175.61933599999998 -40.3385357,175.61956399999997 -40.33853160000002,175.61956399999997 -40.3385766,175.6196042 -40.33858070000001,175.6195988 -40.3385623,175.6196739 -40.3385582,175.61967660000002 -40.33859089999999,175.6196337 -40.338595,175.6196337 -40.33864199999999,175.6195157 -40.33864,175.6195049 -40.3385766,175.6193977 -40.3385766,175.619399 -40.3386492,175.6193199 -40.33864510000001,175.6193263 -40.33865839999999,175.619227 -40.33865430000001,175.6192109 -40.339055,175.6192914 -40.3390529,175.6192914 -40.3390775,175.6193745 -40.3390775,175.6193611 -40.33909789999999,175.61937719999997 -40.3391184,175.6194872 -40.3391204,175.6194926 -40.3388424,175.6197353 -40.338844400000006,175.6197382 -40.33891400000001,175.6196551 -40.33891,175.6196484 -40.339028500000005,175.6195974 -40.339024499999994,175.6195867 -40.33906529999999,175.6196466 -40.3390726,175.61975929999997 -40.339068499999996,175.61975929999997 -40.3391544,175.6191343 -40.339136,175.6191263 -40.3391687,175.6190914 -40.3391666,175.619078 -40.3392872,175.6189332 -40.33928319999999,175.6189251 -40.339377199999994,175.61906460000003 -40.33939050000001,175.6190619 -40.3394242,175.6191987 -40.339431399999995,175.6192014 -40.339396600000015,175.6193502 -40.3394038,175.6193623 -40.3392954,175.6192148 -40.3392883,175.6192215 -40.3391891,175.6193087 -40.33919220000001,175.61930329999998 -40.339262700000006,175.6193851 -40.33926679999999,175.6193854 -40.3393056,175.6196697 -40.33931690000001,175.6196522 -40.3394784,175.6195959 -40.339477300000006,175.6195785 -40.339585700000015,175.619781 -40.3396031,175.6197991 -40.33948740000001,175.61981790000002 -40.3392993,175.6198474 -40.3393014,175.61986080000003 -40.33919709999999,175.61990909999997 -40.33919709999999,175.61988229999997 -40.33945469999998,175.6200995 -40.339469,175.6201237 -40.33920830000001,175.6202819 -40.3392104,175.6202806 -40.339238,175.6202055 -40.3392339,175.6201869 -40.3394321,175.6205142 -40.3394403,175.6205276 -40.3392256,175.6206134 -40.3392235,175.6206188 -40.339246,175.62060539999996 -40.33938710000001,175.620659 -40.339385100000015,175.6206644 -40.3394055,175.6208789 -40.339413699999994,175.6208897 -40.3392379,175.62064829999997 -40.33922969999999,175.620651 -40.339194899999995,175.6207261 -40.339199,175.62072870000003 -40.3391643,175.620887 -40.339172399999995,175.6208897 -40.339107,175.6210157 -40.339105,175.62102109999998 -40.33897,175.6209031 -40.338968,175.6209031 -40.3388637,175.6208199 -40.33885550000001,175.6208152 -40.33873450000001,175.6205779 -40.33872999999999,175.6205779 -40.3387054,175.6208073 -40.3386298,175.620755 -40.338555199999995,175.6206678 -40.33849180000001,175.6205712 -40.3384652,175.6205444 -40.3384887,175.6205444 -40.33845600000001,175.62057390000004 -40.33845600000001,175.6205766 -40.3383824,175.62055249999997 -40.338381399999996,175.62054839999996 -40.33835890000001,175.6204519 -40.3383579,175.6204519 -40.338381399999996,175.6204063 -40.3383834,175.6204036 -40.3383374,175.6200697 -40.3383313,175.6200643 -40.33823420000001,175.6200898 -40.3382281,175.62009780000002 -40.33821069999999,175.620134 -40.3382076,175.6201273 -40.33816879999999,175.62007500000004 -40.3381391,175.6200616 -40.3381504,175.6199543 -40.3381463,175.61992479999998 -40.3381361,175.6198685 -40.3381596,175.61986450000003 -40.33819129999999,175.6198497 -40.3381984,175.6198752 -40.33822399999999,175.6199463 -40.3382301,175.6199516 -40.33832420000001))','Hospital';
--EXEC UDP_INSERT_WKT 'POLYGON', '((175.57602370000004 -40.36713869999999,175.5761297 -40.367235700000016,175.5763724 -40.367077900000005,175.57626649999997 -40.366982300000004,175.57602370000004 -40.36713869999999))', 'House';
--EXEC UDP_INSERT_WKT 'POLYGON', '((175.61081970000004 -40.3376475,175.61663480000004 -40.3452036,175.6275567 -40.3403789,175.6215057 -40.332838699999996,175.61081970000004 -40.3376475))','Buffer Zone Around Hospital';
--GO
--select * from POINTS;
--select * from LINESTRINGS;
--select * from POLYGONS;

--Task 03.
DROP VIEW IF EXISTS VW_ALL_SHAPES;
GO
CREATE VIEW VW_ALL_SHAPES AS
SELECT 'POINT' AS shape_type, point AS shape, label FROM points
UNION ALL
SELECT 'POLYGON' AS shape_type, polygon AS shape, label FROM polygons
UNION ALL
SELECT 'LINESTRING' AS shape_type, linestring AS shape, label FROM linestrings
UNION ALL
SELECT 'BUFFERED_POINT' AS shape_type, point.STBuffer(50) AS shape, label FROM points;
GO
--SELECT * FROM VW_ALL_SHAPES

--Task 04.
DROP PROCEDURE IF EXISTS UDP_ROUTE_DIFFERENCES_IN_METERS;
GO

CREATE PROCEDURE UDP_ROUTE_DIFFERENCES_IN_METERS 
AS
BEGIN
	DECLARE @route1 FLOAT;
	DECLARE @route2 FLOAT;
	DECLARE @result VARCHAR(MAX);

	-- Calculate the length in meters of the first linestring
    SELECT @route1 = SUM(linestring.STLength()) FROM linestrings WHERE id = 1

    -- Calculate the length in meters of the second linestring
    SELECT @route2 = SUM(linestring.STLength()) FROM linestrings WHERE id = 2


	-- Calculate the difference and show the message
	SET @result = 'Route differences in meters. Route 1 is ' + CAST(@route1 AS VARCHAR(20)) + ' meters. Route 2 is ' + CAST(@route2 AS VARCHAR(20)) + ' meters. The difference in distance is ' + CAST(@route2 - @route1 AS VARCHAR(50)) + ' meters';

	SELECT @result AS 'Route differences in meters';
END
GO



--Task 5 and 6
DROP PROCEDURE IF EXISTS UDP_DISJOINT;
GO
CREATE PROCEDURE UDP_DISJOINT
    @disjointValue INT
AS
BEGIN
	
	-- Showing POINTS inside the Buffer Zone
	IF @disjointValue = 0
    BEGIN
        SELECT 'POINT' AS shape_type, point AS shape, label FROM points
        WHERE id IN (1, 2, 3)
        UNION ALL
        SELECT 'POLYGON' AS shape_type, polygon AS shape, label
        FROM polygons
        WHERE id = 3
        UNION ALL
        SELECT 'BUFFERED_POINT' AS shape_type, CAST(point.STBuffer(50) AS NVARCHAR(MAX)) AS shape, label
        FROM points
        WHERE id IN (1, 2, 3)
    END
	
	-- Showing POINTS outside the Buffer Zone
	ELSE IF @disjointValue = 1
    BEGIN
        SELECT 'POINT' AS shape_type, point AS shape, label FROM points
        WHERE id IN (4, 5, 6)
        UNION ALL
        SELECT 'POLYGON' AS shape_type, polygon AS shape, label
        FROM polygons
        WHERE id = 3
        UNION ALL
        SELECT 'BUFFERED_POINT' AS shape_type, CAST(point.STBuffer(50) AS NVARCHAR(MAX)) AS shape, label
        FROM points
        WHERE id IN (4, 5, 6)
    END
END
GO
--EXEC UDP_DISJOINT 0;
--EXEC UDP_DISJOINT 1;


--Task 7


DROP TABLE IF EXISTS event_logs;
GO
CREATE TABLE event_logs (

    user_name NVARCHAR(50),
    date_time DATETIME,
    attempt_type NVARCHAR(50),
    view_name NVARCHAR(100)
);

-- Create the TRG_PREVENT_VIEW_DROP trigger
IF EXISTS (SELECT * FROM sys.triggers WHERE name = 'TRG_PREVENT_VIEW_DROP')
BEGIN
    ENABLE TRIGGER TRG_PREVENT_VIEW_DROP ON DATABASE;
END
GO


IF NOT EXISTS (SELECT * FROM sys.triggers WHERE name = 'TRG_PREVENT_VIEW_DROP')
BEGIN
    EXEC('CREATE TRIGGER TRG_PREVENT_VIEW_DROP
ON DATABASE
FOR DROP_VIEW
AS
BEGIN
    SET NOCOUNT ON;
	-- Declare the log_data table variable
	DECLARE @log_data TABLE (
		user_name NVARCHAR(50),
		date_time DATETIME,
		attempt_type NVARCHAR(50),
		view_name NVARCHAR(100)
	);


    -- Get the user, date/time, and view name
    DECLARE @user_name NVARCHAR(50) = SUSER_SNAME();
    DECLARE @date_time DATETIME = GETDATE();
    DECLARE @view_name NVARCHAR(100) = EVENTDATA().value(''(/EVENT_INSTANCE/ObjectName)[1]'', ''NVARCHAR(100)'');
	DECLARE @attempt_type NVARCHAR(50) = ''DROP_VIEW'';

    -- Log the action in the event_logs table
    INSERT INTO event_logs (user_name, date_time, attempt_type, view_name)
    VALUES (@user_name, @date_time, ''DROP_VIEW'', @view_name);

    -- Display the error message and rollback the transaction
    PRINT ''View dropping is prohibited!!!''
	PRINT ''Rolling back Transaction''
    ROLLBACK;

	-- Insert the log data into the @log_data table variable
	INSERT INTO @log_data (user_name, date_time, attempt_type, view_name)
	VALUES (@user_name, @date_time, @attempt_type, @view_name);

	-- Insert the log data from @log_data into the event_logs table
	INSERT INTO event_logs (user_name, date_time, attempt_type, view_name)
	SELECT user_name, date_time, attempt_type, view_name
	FROM @log_data;
	END')
END;
GO

--DROP VIEW VW_ALL_SHAPES;
--SELECT * FROM event_logs;

--Task 8
exec UDP_CREATE_TABLES; 


EXEC UDP_INSERT_WKT 'POINT', '(175.61798899999997 -40.340238899999996)', 'Point 1';
EXEC UDP_INSERT_WKT 'POINT', '(175.62150809999997 -40.335364799999994)', 'Point 2';
EXEC UDP_INSERT_WKT 'POINT', '(175.6246409 -40.3386361)', 'Point 3';
EXEC UDP_INSERT_WKT 'POINT', '(175.608436 -40.3571431)', 'Point 4';
EXEC UDP_INSERT_WKT 'POINT', '(175.5944019 -40.3634922)', 'Point 5';
EXEC UDP_INSERT_WKT 'POINT', '(175.5752195 -40.3660887)', 'Point 6';

EXEC UDP_INSERT_WKT 'LINESTRING','(175.62074699999997 -40.3380827,175.6188587 -40.33556389999999,175.57156099999997 -40.35680430000001,175.57258019999998 -40.3580715,175.5729986 -40.360082699999985,175.57486169999999 -40.36267250000001,175.5741479 -40.3638984,175.57379380000003 -40.364405299999994,175.5759181 -40.3672255)','Route 1';
EXEC UDP_INSERT_WKT 'LINESTRING','(175.62074699999997 -40.3380827,175.62392999999997 -40.3420535,175.6288356 -40.3485573,175.58008379999998 -40.370270999999995,175.57967539999999 -40.3694905,175.5763024 -40.3675167,175.5759181 -40.3672255)','Route 2';

EXEC UDP_INSERT_WKT 'POLYGON', '((175.6199516 -40.33832420000001,175.6197962 -40.33832309999999,175.6197949 -40.338338500000006,175.6196943 -40.3383374,175.6196903 -40.3383078,175.6195736 -40.3383109,175.6195736 -40.3383006,175.6194355 -40.33830170000001,175.6193697 -40.3382413,175.6192759 -40.3382373,175.61923969999998 -40.3383037,175.6192799 -40.33834149999999,175.61931480000004 -40.33834250000001,175.6193134 -40.338409,175.6193443 -40.33843250000001,175.6193081 -40.3384478,175.6193011 -40.33850499999999,175.61933599999998 -40.3385357,175.61956399999997 -40.33853160000002,175.61956399999997 -40.3385766,175.6196042 -40.33858070000001,175.6195988 -40.3385623,175.6196739 -40.3385582,175.61967660000002 -40.33859089999999,175.6196337 -40.338595,175.6196337 -40.33864199999999,175.6195157 -40.33864,175.6195049 -40.3385766,175.6193977 -40.3385766,175.619399 -40.3386492,175.6193199 -40.33864510000001,175.6193263 -40.33865839999999,175.619227 -40.33865430000001,175.6192109 -40.339055,175.6192914 -40.3390529,175.6192914 -40.3390775,175.6193745 -40.3390775,175.6193611 -40.33909789999999,175.61937719999997 -40.3391184,175.6194872 -40.3391204,175.6194926 -40.3388424,175.6197353 -40.338844400000006,175.6197382 -40.33891400000001,175.6196551 -40.33891,175.6196484 -40.339028500000005,175.6195974 -40.339024499999994,175.6195867 -40.33906529999999,175.6196466 -40.3390726,175.61975929999997 -40.339068499999996,175.61975929999997 -40.3391544,175.6191343 -40.339136,175.6191263 -40.3391687,175.6190914 -40.3391666,175.619078 -40.3392872,175.6189332 -40.33928319999999,175.6189251 -40.339377199999994,175.61906460000003 -40.33939050000001,175.6190619 -40.3394242,175.6191987 -40.339431399999995,175.6192014 -40.339396600000015,175.6193502 -40.3394038,175.6193623 -40.3392954,175.6192148 -40.3392883,175.6192215 -40.3391891,175.6193087 -40.33919220000001,175.61930329999998 -40.339262700000006,175.6193851 -40.33926679999999,175.6193854 -40.3393056,175.6196697 -40.33931690000001,175.6196522 -40.3394784,175.6195959 -40.339477300000006,175.6195785 -40.339585700000015,175.619781 -40.3396031,175.6197991 -40.33948740000001,175.61981790000002 -40.3392993,175.6198474 -40.3393014,175.61986080000003 -40.33919709999999,175.61990909999997 -40.33919709999999,175.61988229999997 -40.33945469999998,175.6200995 -40.339469,175.6201237 -40.33920830000001,175.6202819 -40.3392104,175.6202806 -40.339238,175.6202055 -40.3392339,175.6201869 -40.3394321,175.6205142 -40.3394403,175.6205276 -40.3392256,175.6206134 -40.3392235,175.6206188 -40.339246,175.62060539999996 -40.33938710000001,175.620659 -40.339385100000015,175.6206644 -40.3394055,175.6208789 -40.339413699999994,175.6208897 -40.3392379,175.62064829999997 -40.33922969999999,175.620651 -40.339194899999995,175.6207261 -40.339199,175.62072870000003 -40.3391643,175.620887 -40.339172399999995,175.6208897 -40.339107,175.6210157 -40.339105,175.62102109999998 -40.33897,175.6209031 -40.338968,175.6209031 -40.3388637,175.6208199 -40.33885550000001,175.6208152 -40.33873450000001,175.6205779 -40.33872999999999,175.6205779 -40.3387054,175.6208073 -40.3386298,175.620755 -40.338555199999995,175.6206678 -40.33849180000001,175.6205712 -40.3384652,175.6205444 -40.3384887,175.6205444 -40.33845600000001,175.62057390000004 -40.33845600000001,175.6205766 -40.3383824,175.62055249999997 -40.338381399999996,175.62054839999996 -40.33835890000001,175.6204519 -40.3383579,175.6204519 -40.338381399999996,175.6204063 -40.3383834,175.6204036 -40.3383374,175.6200697 -40.3383313,175.6200643 -40.33823420000001,175.6200898 -40.3382281,175.62009780000002 -40.33821069999999,175.620134 -40.3382076,175.6201273 -40.33816879999999,175.62007500000004 -40.3381391,175.6200616 -40.3381504,175.6199543 -40.3381463,175.61992479999998 -40.3381361,175.6198685 -40.3381596,175.61986450000003 -40.33819129999999,175.6198497 -40.3381984,175.6198752 -40.33822399999999,175.6199463 -40.3382301,175.6199516 -40.33832420000001))','Hospital';
EXEC UDP_INSERT_WKT 'POLYGON', '((175.57602370000004 -40.36713869999999,175.5761297 -40.367235700000016,175.5763724 -40.367077900000005,175.57626649999997 -40.366982300000004,175.57602370000004 -40.36713869999999))', 'House';
EXEC UDP_INSERT_WKT 'POLYGON', '((175.61081970000004 -40.3376475,175.61663480000004 -40.3452036,175.6275567 -40.3403789,175.6215057 -40.332838699999996,175.61081970000004 -40.3376475))','Buffer Zone Around Hospital';

SELECT * FROM VW_ALL_SHAPES;

exec UDP_ROUTE_DIFFERENCES_IN_METERS;

exec UDP_DISJOINT 0; 
exec UDP_DISJOINT 1; 

DROP VIEW VW_ALL_SHAPES; 
SELECT * FROM event_logs;
